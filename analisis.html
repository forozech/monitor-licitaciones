
<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Adjudicaciones | Euskadi</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --bs-primary-rgb: 13, 110, 253; --bg-color: #f4f6f8; --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        body { background-color: var(--bg-color); font-family: 'Segoe UI', system-ui, sans-serif; font-size: 0.9rem; }
        
        /* Tarjetas KPI */
        .kpi-card { background: white; border: none; border-radius: 12px; padding: 20px; box-shadow: var(--card-shadow); height: 100%; position: relative; overflow: hidden; transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-3px); }
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: #1e293b; margin-bottom: 0; line-height: 1.2; }
        .kpi-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: #64748b; font-weight: 600; }
        .kpi-icon { position: absolute; right: -10px; top: -10px; font-size: 5rem; opacity: 0.05; color: #000; transform: rotate(15deg); }

        /* Contenedores */
        .dashboard-card { background: white; border-radius: 12px; box-shadow: var(--card-shadow); padding: 20px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .card-header-custom { font-size: 0.85rem; font-weight: 700; text-transform: uppercase; color: #475569; margin-bottom: 15px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }

        /* Tabla */
        table.dataTable thead th { background-color: #f8fafc; color: #475569; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; border-bottom: 2px solid #e2e8f0 !important; }
        table.dataTable tbody td { vertical-align: middle; color: #334155; }
        
        /* Badges y Etiquetas */
        .badge-baja { font-weight: 700; padding: 4px 8px; border-radius: 6px; min-width: 50px; display: inline-block; text-align: center; font-size: 0.8rem; }
        .baja-alta { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; } /* > 15% */
        .baja-media { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; } /* 5-15% */
        .baja-baja { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; } /* < 5% */
        .baja-negativa { background-color: #f1f5f9; color: #64748b; } 

        .badge-estado { font-size: 0.7rem; padding: 3px 8px; border-radius: 12px; font-weight: 600; }
        .estado-adj { background-color: #e0f2fe; color: #075985; border: 1px solid #bae6fd; }
        .estado-form { background-color: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
        .estado-cerr { background-color: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; }

        /* Modal */
        .modal-content { border-radius: 16px; border: none; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal-header { background-color: #f8fafc; border-bottom: 1px solid #e2e8f0; border-radius: 16px 16px 0 0; }
        .rival-item { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .rival-item:last-child { border-bottom: none; }
        .rival-winner { background-color: #f0fdf4; color: #15803d; font-weight: 600; border-radius: 8px; margin-bottom: 5px; border: 1px solid #bbf7d0; }
    </style>
</head>
<body>
    <div class="container-fluid px-4 py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark mb-0"><i class="bi bi-bar-chart-fill text-primary me-2"></i>Monitor de Adjudicaciones</h2>
                <p class="text-muted mb-0 small">Análisis de resultados, bajas y competencia en Gipuzkoa (2025)</p>
            </div>
            <div class="text-end">
                <span class="badge bg-white text-secondary border shadow-sm py-2 px-3">
                    <i class="bi bi-clock me-1"></i> Actualizado: <span id="lastUpdate">28/01/2026 19:09</span>
                </span>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="kpi-card">
                    <i class="bi bi-cash-stack kpi-icon"></i>
                    <div class="kpi-label">Volumen Adjudicado</div>
                    <div class="kpi-value" id="kpi-volumen">0 €</div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="kpi-card">
                    <i class="bi bi-percent kpi-icon"></i>
                    <div class="kpi-label">Baja Media Global</div>
                    <div class="kpi-value text-primary" id="kpi-baja">0%</div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="kpi-card">
                    <i class="bi bi-people-fill kpi-icon"></i>
                    <div class="kpi-label">Competencia Media</div>
                    <div class="kpi-value" id="kpi-licitadores">0</div>
                    <div class="small text-muted mt-1">Empresas por licitación</div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="kpi-card">
                    <i class="bi bi-file-earmark-check kpi-icon"></i>
                    <div class="kpi-label">Contratos Procesados</div>
                    <div class="kpi-value" id="kpi-contratos">0</div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-8">
                <div class="dashboard-card h-100">
                    <div class="card-header-custom">Distribución de Bajas (Ahorro %)</div>
                    <div style="height: 220px;"><canvas id="chartBajas"></canvas></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dashboard-card h-100">
                    <div class="card-header-custom">Top Adjudicatarios</div>
                    <div style="height: 220px; position: relative;"><canvas id="chartWinners"></canvas></div>
                </div>
            </div>
        </div>

        <div class="dashboard-card">
            <div class="card-header-custom">Detalle de Contratos</div>
            <table id="tablaContratos" class="table table-hover w-100">
                <thead>
                    <tr>
                        <th width="10%">Expediente</th>
                        <th width="30%">Objeto / Ganador</th>
                        <th width="12%" class="text-end">Presupuesto</th>
                        <th width="12%" class="text-end">Adjudicación</th>
                        <th width="8%" class="text-center">Baja</th>
                        <th width="8%" class="text-center">Rivales</th>
                        <th width="10%" class="text-center">Estado</th>
                        <th width="10%"></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="modalDetalle" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Análisis del Expediente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-light border mb-4">
                        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Objeto del contrato</small>
                        <p class="mb-0 fw-bold text-dark" id="modalObjeto" style="line-height: 1.4;">...</p>
                    </div>

                    <div class="row mb-4">
                        <div class="col-6">
                            <div class="p-3 bg-light rounded border">
                                <span class="d-block text-muted small text-uppercase fw-bold">Presupuesto Base</span>
                                <span class="h5 fw-bold text-dark mb-0" id="modalBase">0 €</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 bg-white rounded border border-success">
                                <span class="d-block text-success small text-uppercase fw-bold">Importe Adjudicación</span>
                                <span class="h5 fw-bold text-success mb-0" id="modalAdj">0 €</span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-7 border-end">
                            <h6 class="fw-bold mb-3 small text-uppercase text-muted">Competencia (<span id="modalNumLic">0</span>)</h6>
                            <div id="modalRivales" class="rival-list" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                        <div class="col-md-5 ps-md-4">
                            <h6 class="fw-bold mb-3 small text-uppercase text-muted">Documentación</h6>
                            <div id="modalDocs" class="d-grid gap-2"></div>
                            <div class="mt-4 pt-3 border-top text-center">
                                <a id="linkFicha" href="#" target="_blank" class="btn btn-sm btn-outline-primary w-100">
                                    <i class="bi bi-box-arrow-up-right me-2"></i>Ver Ficha en Euskadi.eus
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

    <script>
        const datos = [];
        const eur = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });

        $(document).ready(function() {
            renderDashboard(datos);
        });

        function renderDashboard(data) {
            // KPIs
            let vol = 0, sumBaja = 0, sumLic = 0, winners = {};
            let validBajaCount = 0;

            data.forEach(d => {
                vol += d.importe_adjudicacion;
                if(d.baja_pct > 0) { sumBaja += d.baja_pct; validBajaCount++; }
                sumLic += d.num_licitadores;
                
                let w = d.ganador.length > 25 ? d.ganador.substring(0, 25) + '...' : d.ganador;
                if(d.ganador !== "Desconocido" && d.ganador !== "Desierto") winners[w] = (winners[w] || 0) + 1;
            });

            $('#kpi-volumen').text(eur.format(vol));
            $('#kpi-baja').text((validBajaCount ? (sumBaja / validBajaCount) : 0).toFixed(2) + '%');
            $('#kpi-licitadores').text((data.length ? (sumLic / data.length) : 0).toFixed(1));
            $('#kpi-contratos').text(data.length);

            // Gráficos
            renderCharts(data, winners);

            // Tabla
            $('#tablaContratos').DataTable({
                data: data,
                language: { url: "//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json" },
                pageLength: 25,
                order: [[ 4, "desc" ]],
                columns: [
                    { data: 'expediente', render: d => `<span class="fw-bold text-dark small">${d}</span>` },
                    { data: null, render: d => `
                        <div style="line-height:1.2">
                            <span class="d-block fw-bold text-primary" style="font-size:0.85rem">${d.ganador}</span>
                            <span class="d-block text-muted text-truncate small" style="max-width: 300px;" title="${d.objeto}">${d.objeto}</span>
                        </div>` 
                    },
                    { data: 'presupuesto_base', className: 'text-end', render: d => `<span class="text-secondary small">${eur.format(d)}</span>` },
                    { data: 'importe_adjudicacion', className: 'text-end', render: d => `<span class="fw-bold text-dark small">${eur.format(d)}</span>` },
                    { data: 'baja_pct', className: 'text-center', render: d => {
                        let cls = 'baja-negativa';
                        if(d >= 15) cls = 'baja-alta'; else if(d >= 5) cls = 'baja-media'; else if(d > 0) cls = 'baja-baja';
                        return `<span class="badge-baja ${cls}">${d}%</span>`;
                    }},
                    { data: 'num_licitadores', className: 'text-center', render: d => `<span class="badge bg-white border text-dark shadow-sm">${d}</span>` },
                    { data: 'estado_fase', className: 'text-center', render: d => {
                         let cls = d === 'ADJUDICADO' ? 'estado-adj' : d === 'FORMALIZADO' ? 'estado-form' : 'estado-cerr';
                         return `<span class="badge-estado ${cls}">${d.substring(0,4)}</span>`;
                    }},
                    { data: null, orderable: false, className: 'text-end', render: (d, type, row, meta) => `
                        <button class="btn btn-sm btn-outline-secondary border-0" onclick='verDetalle(${meta.row})'><i class="bi bi-eye-fill"></i></button>` 
                    }
                ]
            });
        }

        function renderCharts(data, winners) {
            const ranges = [0, 0, 0, 0];
            data.forEach(d => {
                if(d.baja_pct <= 0.5) ranges[0]++; // Consideramos <0.5 como sin baja
                else if(d.baja_pct < 10) ranges[1]++;
                else if(d.baja_pct < 20) ranges[2]++;
                else ranges[3]++;
            });

            new Chart(document.getElementById('chartBajas'), {
                type: 'bar',
                data: {
                    labels: ['Sin Baja', 'Baja < 10%', '10% - 20%', '> 20%'],
                    datasets: [{ data: ranges, backgroundColor: ['#f1f5f9', '#fef08a', '#86efac', '#22c55e'], borderRadius: 6 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
            });

            const sorted = Object.entries(winners).sort((a,b) => b[1]-a[1]).slice(0, 5);
            new Chart(document.getElementById('chartWinners'), {
                type: 'doughnut',
                data: {
                    labels: sorted.map(x => x[0]),
                    datasets: [{ data: sorted.map(x => x[1]), backgroundColor: ['#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } }, cutout: '75%' }
            });
        }

        window.verDetalle = function(idx) {
            const d = datos[idx];
            $('#modalObjeto').text(d.objeto);
            $('#modalBase').text(eur.format(d.presupuesto_base));
            $('#modalAdj').text(eur.format(d.importe_adjudicacion));
            $('#modalNumLic').text(d.num_licitadores);
            $('#linkFicha').attr('href', d.url_ficha);

            let htmlRivales = '';
            d.rivales.forEach(r => {
                const isWinner = r === d.ganador;
                htmlRivales += `<div class="rival-item ${isWinner ? 'rival-winner' : ''}">
                    <span>${r}</span>
                    ${isWinner ? '<i class="bi bi-trophy-fill text-success"></i>' : ''}
                </div>`;
            });
            $('#modalRivales').html(htmlRivales || '<div class="text-center text-muted py-3 small fst-italic">No hay información detallada de rivales</div>');

            let htmlDocs = '';
            d.documentos.forEach(doc => {
                htmlDocs += `<a href="${doc.url}" target="_blank" class="btn btn-outline-secondary btn-sm text-start text-truncate w-100 mb-2">
                    <i class="bi bi-file-earmark-pdf text-danger me-2"></i>${doc.nombre}
                </a>`;
            });
            $('#modalDocs').html(htmlDocs || '<div class="text-center text-muted py-3 small">Sin documentos públicos</div>');

            new bootstrap.Modal('#modalDetalle').show();
        };
    </script>
</body>
</html>
